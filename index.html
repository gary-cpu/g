<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Circle Measurement Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pyodide/0.23.4/pyodide.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        #results {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            display: none;
        }
        canvas {
            max-width: 100%;
            border: 1px solid #ccc;
        }
        .loading {
            display: none;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Circle Measurement Tool</h1>
        <p>Upload an image containing a dark circle on a lighter background:</p>
        <input type="file" id="imageInput" accept="image/*">
        <canvas id="previewCanvas"></canvas>
        <div id="loading" class="loading">Processing...</div>
        <div id="results"></div>
    </div>

    <script>
        async function initPyodide() {
            let pyodide = await loadPyodide();
            await pyodide.loadPackage(['numpy', 'scikit-image']);
            
            await pyodide.runPythonAsync(`
                import numpy as np
                from skimage import filters, measure, morphology
                from js import ImageData, Uint8ClampedArray

                def process_image(image_data, width, height):
                    # Convert ImageData to numpy array
                    data = np.frombuffer(image_data, dtype=np.uint8)
                    img = data.reshape((height, width, 4))
                    
                    # Convert to grayscale
                    gray = np.dot(img[...,:3], [0.299, 0.587, 0.114])
                    
                    # Apply Otsu's thresholding
                    thresh = filters.threshold_otsu(gray)
                    binary = gray < thresh
                    
                    # Clean up binary image
                    binary = morphology.remove_small_objects(binary)
                    binary = morphology.remove_small_holes(binary)
                    
                    # Find contours
                    contours = measure.find_contours(binary, 0.5)
                    
                    if not contours:
                        return "No circle detected"
                    
                    # Find the largest contour (assumed to be the circle)
                    largest_contour = max(contours, key=len)
                    
                    # Calculate properties
                    props = measure.regionprops(binary.astype(int))[0]
                    
                    # Calculate area
                    area = props.area
                    
                    # Calculate perimeter
                    perimeter = props.perimeter
                    
                    # Calculate circularity
                    circularity = 4 * np.pi * area / (perimeter ** 2)
                    
                    # Calculate diameters at different angles
                    cx, cy = props.centroid
                    angles = [0, 60, 120]
                    diameters = []
                    
                    for angle in angles:
                        rad = np.radians(angle)
                        dx = np.cos(rad)
                        dy = np.sin(rad)
                        
                        # Find intersection points with contour
                        distances = []
                        for point in largest_contour:
                            px = point[0] - cx
                            py = point[1] - cy
                            dist = abs(px * dy - py * dx)
                            distances.append(dist)
                        
                        diameter = np.max(distances) * 2
                        diameters.append(diameter)
                    
                    avg_diameter = np.mean(diameters)
                    
                    return {
                        'area': area,
                        'circumference': perimeter,
                        'diameters': diameters,
                        'avg_diameter': avg_diameter,
                        'circularity': circularity
                    }
            `);
            
            return pyodide;
        }

        let pyodide;
        
        // Initialize Pyodide when the page loads
        window.addEventListener('load', async () => {
            try {
                pyodide = await initPyodide();
            } catch (error) {
                console.error('Failed to initialize Pyodide:', error);
            }
        });

        // Handle image upload
        document.getElementById('imageInput').addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const img = new Image();
                img.onload = async () => {
                    const canvas = document.getElementById('previewCanvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Set canvas size to match image
                    canvas.width = img.width;
                    canvas.height = img.height;
                    
                    // Draw image on canvas
                    ctx.drawImage(img, 0, 0);
                    
                    // Get image data
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    
                    // Show loading indicator
                    document.getElementById('loading').style.display = 'block';
                    document.getElementById('results').style.display = 'none';
                    
                    try {
                        // Process image with Python
                        const result = await pyodide.runPythonAsync(`
                            process_image(${imageData.data.buffer}, ${canvas.width}, ${canvas.height})
                        `);
                        
                        // Display results
                        const resultsDiv = document.getElementById('results');
                        if (typeof result === 'string') {
                            resultsDiv.innerHTML = result;
                        } else {
                            resultsDiv.innerHTML = `
                                <h2>Measurement Results:</h2>
                                <p>Area: ${result.area.toFixed(2)} pixels²</p>
                                <p>Circumference: ${result.circumference.toFixed(2)} pixels</p>
                                <p>Diameters:</p>
                                <ul>
                                    <li>0°: ${result.diameters[0].toFixed(2)} pixels</li>
                                    <li>60°: ${result.diameters[1].toFixed(2)} pixels</li>
                                    <li>120°: ${result.diameters[2].toFixed(2)} pixels</li>
                                </ul>
                                <p>Average Diameter: ${result.avg_diameter.toFixed(2)} pixels</p>
                                <p>Circularity: ${(result.circularity * 100).toFixed(2)}% 
                                   (100% indicates perfect circle)</p>
                            `;
                        }
                        resultsDiv.style.display = 'block';
                    } catch (error) {
                        console.error('Processing failed:', error);
                        document.getElementById('results').innerHTML = 'Error processing image: ' + error.message;
                        document.getElementById('results').style.display = 'block';
                    } finally {
                        document.getElementById('loading').style.display = 'none';
                    }
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    </script>
</body>
</html>